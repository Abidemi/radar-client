<div crud>
  <div ng-show="!viewing && !editing">
    <div result-table-selector result-specs="resultSpecs"></div>
  </div>

  <div loading="loading">
    <div ng-if="viewing">
      <p>
        <span crud-list-button></span>
        <span crud-edit-button item="item"></span>
        <span crud-remove-button item="item"></span>
      </p>

      <table class="table properties">
        <tr>
          <th>ID</th>
          <td>{{item.id}}</td>
        </tr>

        <tr>
          <th>Data Source</th>
          <td>{{item.dataSource.getName()}}</td>
        </tr>

        <tr>
          <th>Date</th>
          <td>{{item.date | dateTimeFormat}}</td>
        </tr>

        <tr>
          <th>Result Type</th>
          <td>{{item.resultGroupSpec.name}}</td>
        </tr>

        <tr ng-repeat="resultSpec in item.resultGroupSpec.resultSpecs">
          <th>{{resultSpec.name}} <span ng-if="resultSpec.units">({{resultSpec.units}})</span></th>
          <td>{{item.getValue(resultSpec.code) | missing}}</td>
        </tr>
      </table>

      <div item-meta item="item"></div>
    </div>

    <div ng-if="editing">
      <p>
        <span crud-list-button></span>
        <span crud-view-button item="originalItem"></span>
      </p>

      <form class="form-horizontal form-container" crud-submit="saveAndView()" novalidate>
        <div frm-field frm-group>
          <div frm-label>Data Source</div>

          <div frm-control>
            <div frm-patient-data-source-field patient="patient" model="item.dataSource" required="true"></div>
            <div frm-errors errors="item.errors.dataSource"></div>
          </div>
        </div>

        <div frm-field frm-group>
          <div frm-label>Date</div>

          <div frm-control>
            <div frm-date-field model="item.date" required="true"></div>
            <div frm-errors errors="item.errors.date"></div>
          </div>
        </div>

        <div frm-field frm-group>
          <div frm-label>Result Type</div>

          <div frm-control>
            <div frm-result-group-spec-field model="item.resultGroupSpec" required="true"></div>
            <div frm-help>See the <a ui-sref="resultSpecs" target="_blank">result types</a> guide.</div>
            <div frm-errors errors="item.errors.resultGroupSpec"></div>
          </div>
        </div>

        <div ng-repeat="resultSpec in item.resultGroupSpec.resultSpecs">
          <div frm-field frm-group>
            <div frm-label>{{resultSpec.name}}</div>

            <div frm-control>
              <div ng-switch="resultSpec.type">
                <div ng-switch-when="INTEGER" frm-integer-field model="item.results[resultSpec.code]"></div>
                <div ng-switch-when="FLOAT" frm-number-field model="item.results[resultSpec.code]" units="{{resultSpec.units}}"></div>
                <div ng-switch-when="STRING" frm-text-field model="item.results[resultSpec.code]"></div>
                <div ng-switch-when="CODED_STRING" frm-select-field model="item.results[resultSpec.code]" options="resultSpec.options"></div>
                <div ng-switch-when="CODED_INTEGER" frm-select-field model="item.results[resultSpec.code]" options="resultSpec.options"></div>
              </div>

              <div frm-errors errors="item.errors.results[resultSpec.code]"></div>
            </div>
          </div>
        </div>

        <div frm-buttons>
          <span crud-save-button></span>
          <span crud-cancel-list-button></span>
        </div>
      </form>
    </div>

    <div ng-if="!viewing && !editing" list-helper="groupedItems as page" per-page="50" sort-by="date" reverse="true">
      <p>
        <span crud-create-button action="create()"></span>
      </p>

      <div ng-show="!page.getCount()">
        <p>No results.</p>
      </div>

      <table class="table table-condensed table-striped" ng-show="page.getCount()">
        <thead>
          <tr>
            <th sort-helper="date">Date</th>

            <th ng-repeat="resultSpec in resultSpecs" sort-helper="results[resultSpec.code].getValue(resultSpec.code)" sort-id="results.{{resultSpec.code}}">
              {{resultSpec.shortName}}
            </th>

            <th sort-helper="dataSource.getName()">Data Source</th>
          </tr>
        </thead>

        <tbody>
          <tr ng-repeat="item in page.getItems()">
            <td>{{item.date | dateTimeFormat}}</td>

            <td ng-repeat="resultSpec in resultSpecs">
              <span ng-if="item.results[resultSpec.code] !== undefined">
                <!-- IE doesn't support ng-disabled on <a> -->

                <span ng-if="viewEnabled(item.results[resultSpec.code])">
                  <a href="" ng-click="view(item.results[resultSpec.code])">{{item.results[resultSpec.code].getValue(resultSpec.code) | missing}}</a>
                </span>

                <span ng-if="!viewEnabled(item.results[resultSpec.code])">
                  <a href="" ng-click="view(item.results[resultSpec.code])">{{item.results[resultSpec.code].getValue(resultSpec.code) | missing}}</a>
                </span>
              </span>
            </td>

            <td class="data-source">{{item.dataSource.getName()}}</td>
          </tr>
        </tbody>
      </table>

      <div pagination-helper></div>
    </div>
  </div>
</div>
